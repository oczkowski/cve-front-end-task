import React, { useEffect } from 'react';

// Importing momentjs library
import moment from 'moment';

// Redux connect functionj
import { connect } from 'react-redux';

// Material UI Components / Utilities
import { makeStyles, createStyles, Theme } from '@material-ui/core/styles';
import Paper from '@material-ui/core/Paper';

// Importing the collapsible table component we created.
import CollapsibleTable from './utilities/CollapsibleTable/CollapsibleTable';

// CVE Item interface
import { CVEItem } from './types';

// Material UI Paper styling
const useStyles = makeStyles((theme: Theme) =>
    createStyles({
        paper: {
            padding: '24px 24px 16px 24px',
            textAlign: 'left',
            color: theme.palette.text.secondary,
        },
    })
);

// Filter Inputs interface
interface filterInputs {
    cveID: string;
    year: number;
    severity: 'low' | 'medium' | 'high' | 'critical';
}

const DataResults = (props: {
    cveItems: Array<CVEItem>;
    language: string;
    filterInputs: filterInputs;
}) => {
    const { cveItems, language, filterInputs } = props;

    const classes = useStyles();

    /**
     * Preparing/Filtering CVE data for the table.
     */
    // NOTE: This data doesn't get refetched so we don't listen to changes on it.
    var tableEntries = cveItems.map((cveItem) => {
        var descriptionByLanguage: {
            lang: string;
            value: string;
        } = cveItem.cve.description.description_data.filter(
            (desc) => desc.lang === language
        )[0];
        return {
            values: [
                cveItem.cve.CVE_data_meta.ID,
                moment(cveItem.publishedDate).format('DD MMM YYYY'),
                cveItem.impact.baseMetricV2
                    ? cveItem.impact.baseMetricV2.severity
                    : 'NONE',
                descriptionByLanguage.value,
            ],
            hiddenValues: {
                'Data Type': cveItem.cve.data_type,
                'Data Format': cveItem.cve.data_format,
                'Data Version': cveItem.cve.data_version,
                Assigner: cveItem.cve.CVE_data_meta.ASSIGNER,
                'Last Modified': moment(cveItem.lastModifiedDate).format(
                    'DD MMM YYYY'
                ),
                'Impact Score': cveItem.impact.baseMetricV2
                    ? cveItem.impact.baseMetricV2.impactScore
                    : 'N/A',
            },
        };
    });

    // If any of filter inputs or language updates, we filter the data agian.
    useEffect(() => {}, [...Object.values(filterInputs), language]);

    return (
        <Paper className={classes.paper}>
            <div>Search Results</div>
            <p />
            <CollapsibleTable
                headers={[
                    `CVE ID`,
                    `PUBLISHED DATE`,
                    `SEVERITY`,
                    `DESCRIPTION`,
                ]}
                entries={tableEntries}
            />
        </Paper>
    );
};

const mapStateToProps = (state: {
    cveData: {
        CVE_Items: Array<CVEItem>;
    };
    themeSettings: {
        language: string;
    };
    filterInputs: filterInputs;
}) => {
    return {
        cveItems: state.cveData.CVE_Items,
        // Please read the reducer description for language.
        language: state.themeSettings.language,
        filterInputs: state.filterInputs,
    };
};

export default connect(mapStateToProps, {})(DataResults);
